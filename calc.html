<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Solar Battery Simulation (Voltage + SoC)</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: sans-serif;
      max-width: 1200px;
      margin: 2em auto;
      background: #f8f9fa;
      padding: 2em;
      border-radius: 8px;
    }
    label, input {
      display: block;
      margin-top: 1em;
      width: 200px;
    }
    input {
      padding: 8px;
      font-size: 1em;
    }
  button {
      margin-top: 1em;
      padding: 10px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .note {
      color: #666;
      font-size: 0.9em;
    }
    canvas {
      display: block;
      width: 100%;
      height: 400px;
      margin-bottom: 30px;
    }
  </style>
</head>
<body>

<h1>Realistic Solar Battery Simulation</h1>

<canvas id="chart"></canvas>

<label for="capacity">Battery Capacity (mAh)</label>
<input type="number" id="capacity" value="300">
<small class="note">Typical AA/AAA NiMH: 300,600 or 1000 mAh</small>

<label for="soc">Initial SoC (%)</label>
<input type="number" id="soc" value="70" min="0" max="100">
<small class="note">Usually 80–100% after full charge</small>

<label for="cells">Cell Count</label>
<input type="number" id="cells" value="1" min="1">
<small class="note">Most garden lights use 1 cell</small>

<label for="chemistry">Battery Chemistry</label>
<select id="chemistry">
  <option value="NiMH" selected>NiMH</option>
  <option value="NiCad">NiCad</option>
</select>
<small class="note">Affects safe discharge voltage</small>

<label for="sunHours">Direct Sunlight Hours</label>
<input type="number" id="sunHours" value="4">
<small class="note">Commonly 3–6 hours</small>

<label for="indirectHours">Indirect Sunlight Hours</label>
<input type="number" id="indirectHours" value="1" min="0">
<small class="note">Shaded or off-angle sun</small>

<label for="morningHours">Indirect Morning Light Hours</label>
<input type="number" id="morningHours" value="1" min="0">
<small class="note">Early dawn ambient light</small>

<label for="nightHours">Night Illumination Hours</label>
<input type="number" id="nightHours" value="8">
<small class="note">Usually 8–12 hours</small>

<label for="ledCurrent">LED Nominal Current @ 1.2V (mA)</label>
<input type="number" id="ledCurrent" value="30">
<small class="note">Typical white LED current: ≈20 mA</small>
<label for="driverEff">LED Driver Efficiency (%)</label>
<input type="number" id="driverEff" value="70" min="0" max="100">
<small class="note">Boost driver: 70–85%</small>

<label for="boostCutoff">Boost Converter Cutoff (V/cell)</label>
<input type="number" id="boostCutoff" value="0.9" step="any">
<small class="note">LED driver stops below this voltage</small>

<label for="sunrise">Sunrise Hour (0–23)</label>
<input type="number" id="sunrise" value="6" min="0" max="23">
<small class="note">Average sunrise ~6am</small>

<label for="sunset">Sunset Hour (0–23)</label>
<input type="number" id="sunset" value="18" min="1" max="23">
<small class="note">Average sunset ~6pm</small>

<label for="days">Days to Simulate</label>
<input type="number" id="days" value="4" min="1" max="600">

<h3>Solar Cell</h3>
<label for="voc">Open-Circuit Voltage (Voc) [V]</label>
<input type="number" id="voc" value="2.0" step="any">

<label for="isc">Short-Circuit Current (Isc) [mA]</label>
<input type="number" id="isc" value="150">

<label for="ff">Fill Factor (FF, 0–1)</label>
<input type="number" id="ff" value="0.65" step="any">

<label for="diodeDrop">Diode Voltage Drop (V)</label>
<input type="number" id="diodeDrop" value="0.4" step="any">

<label for="chargeEff">Charge Efficiency (%)</label>
<input type="number" id="chargeEff" value="70" min="0" max="100">

<label for="selfDischarge">Self-Discharge Rate (%/day)</label>
<input type="number" id="selfDischarge" value="3" min="0" step="any">

<label><input type="checkbox" id="enableDeg" checked> Simulate Component Degeneration</label>
<label for="degBattery">Battery Capacity Loss per Day (%)</label>
<input type="number" id="degBattery" value="0.05" step="any">
<small class="note">Typical NiCad loses ~0.05% per day</small>
<label for="degSolar">Solar Cell Power Loss per Day (%) (resin)</label>
<input type="number" id="degSolar" value="0.1" step="any">
<small class="note">Panel aging ~0.02% per day</small>

<button onclick="simulate()">Simulate</button>


<script>
let chart;

function simulate() {
  let capacity = parseFloat(document.getElementById("capacity").value);
  const initialSoC = parseFloat(document.getElementById("soc").value);
  const cells = parseInt(document.getElementById("cells").value);
  const sunHours = parseInt(document.getElementById("sunHours").value);
  const indirectHours = parseInt(document.getElementById("indirectHours").value);
  const morningHours = parseInt(document.getElementById("morningHours").value);
  const nightHours = parseInt(document.getElementById("nightHours").value);
  const sunrise = parseInt(document.getElementById("sunrise").value);
  const sunset = parseInt(document.getElementById("sunset").value);
  const boostCutoff = parseFloat(document.getElementById("boostCutoff").value);
  const ledNominalCurrent = parseFloat(document.getElementById("ledCurrent").value);
  const driverEff = parseFloat(document.getElementById("driverEff").value) / 100;
  const days = Math.min(1200, parseInt(document.getElementById("days").value));
  let voc = parseFloat(document.getElementById("voc").value);
  let isc = parseFloat(document.getElementById("isc").value);
  const ff = parseFloat(document.getElementById("ff").value);
  const diodeDrop = parseFloat(document.getElementById("diodeDrop").value);
  const chargeEff = parseFloat(document.getElementById("chargeEff").value) / 100;
  const selfDischarge = parseFloat(document.getElementById("selfDischarge").value) / 100;
  const enableDeg = document.getElementById("enableDeg").checked;
  const degBattery = parseFloat(document.getElementById("degBattery").value) / 100;
  const degSolar = parseFloat(document.getElementById("degSolar").value) / 100;
  const chemistry = document.getElementById("chemistry").value;
  const minCellV = chemistry === "NiCad" ? 0.9 : 1.0;
  const overChargeV = chemistry === "NiCad" ? 1.55 : 1.45;
  const maxCellV = chemistry === "NiCad" ? 1.65 : 1.55;
  const damageData = [];

  let soc = initialSoC;
  const socData = [];
  const socColors = [];
  const voltageData = [];
  const ledData = [];
  const sunData = [];
  const indirectData = [];
  const dayData = [];
  const morningData = [];
  const currentData = [];
  const currentDaily = [];
  const labels = [];
  const labelsDaily = [];
  const socHigh = [];
  const socLow = [];
  const voltageHigh = [];
  const voltageLow = [];
  // Non-direct light factors based on typical cloudy-day output
  // Solar panels produce around 10–25% of normal power when clouds block the sun
  // See: duckduckgo result snippet mentioning 10–25% output on cloudy days
  const dayFactor = 0.2; // daylight but not direct sun
  const morningFactor = 0.05; // very low early morning light
  const indirectFactor = 0.1; // shaded or indirect sunlight

  // LED power at 1.5V baseline
  const ledPower_mW = 1.5 * ledNominalCurrent;
  let overCharge = 0;

  for (let day = 0; day < days; day++) {
    if (day > 0 && enableDeg) {
      capacity *= (1 - degBattery);
      voc *= (1 - degSolar);
      isc *= (1 - degSolar);
    }

    for (let hour = 0; hour < 24; hour++) {
      labels.push(`Day ${day + 1}, ${hour}:00`);
      socData.push(soc);

      // Battery voltage estimate with overcharge handling
      const cellV = Math.min(
        maxCellV,
        1.0 + 0.35 * (soc / 100) + 0.01 * overCharge
      );
      const batteryV = cells * cellV;
      voltageData.push(batteryV);
      damageData.push((batteryV > cells * overChargeV || batteryV < cells * minCellV) ? batteryV : null);

      socColors.push(soc > 80 ? 'gold' : soc < 30 ? 'red' : '#28a745');

      let delta_mAh = 0;
      const directSunEnd = Math.min(sunset, sunrise + sunHours);
      const indirectEnd = Math.min(sunset, directSunEnd + indirectHours);
      const isSun = hour >= sunrise && hour < directSunEnd;
      const isIndirect = hour >= directSunEnd && hour < indirectEnd;
      const isDay = hour >= sunrise && hour < sunset;
      const morningStart = sunrise - morningHours;
      const isMorning = morningHours > 0 && (morningStart >= 0
        ? (hour >= morningStart && hour < sunrise)
        : (hour >= morningStart + 24 || hour < sunrise));
      const nightEnd = (sunset + nightHours) % 24;
      const isNight = nightEnd > sunset ?
        (hour >= sunset && hour < nightEnd) :
        (hour >= sunset || hour < nightEnd);

      sunData.push(isSun ? 1 : 0);
      indirectData.push(isIndirect ? 1 : 0);
      dayData.push(isDay && !isSun && !isIndirect ? 1 : 0);
      morningData.push(isMorning ? 1 : 0);

      const ledOn = isNight && batteryV > cells * boostCutoff;
      ledData.push(ledOn ? 1 : 0);

      if (isSun || isIndirect || isDay || isMorning) {
        let intensity = 0;
        if (isSun) {
          intensity = 1;
        } else if (isIndirect) {
          intensity = indirectFactor;
        } else if (isDay) {
          intensity = dayFactor;
        }
        if (isMorning) intensity = Math.max(intensity, morningFactor);

        if (intensity > 0) {
          const vLoad = batteryV + diodeDrop;
          if (vLoad < voc) {
            const pMax = voc * isc * ff * intensity; // mW scaled by light level
            const vmpp = voc * 0.8; // approximate voltage at MPP
            const impp = pMax / vmpp; // current at MPP
            let solarCurrent;
            if (vLoad <= vmpp) {
              // operate near MPP for lower battery voltage
              solarCurrent = pMax / vLoad;
            } else {
              // linear drop of current above MPP toward Voc
              solarCurrent = impp * (1 - (vLoad - vmpp) / (voc - vmpp));
            }
            solarCurrent = Math.max(0, Math.min(isc * intensity, solarCurrent));

            delta_mAh = solarCurrent * chargeEff; // 1 hour
          }
        }
      } else if (ledOn) {
        // Adjust LED current to maintain constant power
        const actualLEDCurrent = batteryV > 0 ? (ledPower_mW / driverEff) / batteryV : 0;
        delta_mAh = -actualLEDCurrent; // 1 hour
      }

      // self discharge (per hour)
      delta_mAh -= (capacity * selfDischarge) / 24;

      const delta_soc = (delta_mAh / capacity) * 100;
      let totalCharge = soc + overCharge + delta_soc;
      if (totalCharge >= 100) {
        soc = 100;
        overCharge = totalCharge - 100;
      } else if (totalCharge >= 0) {
        soc = totalCharge;
        overCharge = 0;
      } else {
        soc = 0;
        overCharge = 0;
      }
      currentData.push(delta_mAh);
    }
  }

  if (days > 15) {
    for (let day = 0; day < days; day++) {
      const start = day * 24;
      const end = start + 24;
      labelsDaily.push(`Day ${day + 1}`);
      socHigh.push(Math.max(...socData.slice(start, end)));
      socLow.push(Math.min(...socData.slice(start, end)));
      voltageHigh.push(Math.max(...voltageData.slice(start, end)));
      voltageLow.push(Math.min(...voltageData.slice(start, end)));
      const avgCur = currentData.slice(start, end).reduce((a, b) => a + b, 0) / 24;
      currentDaily.push(avgCur);
    }
  }

  const curArray = days > 15 ? currentDaily : currentData;
  const maxCurrent = curArray.reduce((m, v) => Math.max(m, Math.abs(v)), 0) || 1;

  const ctx = document.getElementById("chart").getContext("2d");
  if (chart) chart.destroy();

  const labelsForChart = days > 15 ? labelsDaily : labels;
  const datasets = [];

  if (days > 15) {
    datasets.push(
      { label: 'Battery SoC High (%)', data: socHigh, borderColor: '#28a745', tension: 0.3, yAxisID: 'ySoC', fill: false },
      { label: 'Battery SoC Low (%)', data: socLow, borderColor: '#28a745', tension: 0.3, yAxisID: 'ySoC', fill: false },
      { label: 'Battery Voltage High (V)', data: voltageHigh, borderColor: '#007bff', tension: 0.3, yAxisID: 'yVoltage', fill: false },
      { label: 'Battery Voltage Low (V)', data: voltageLow, borderColor: '#007bff', tension: 0.3, yAxisID: 'yVoltage', fill: false }
    );
  } else {
    datasets.push(
      { label: 'Battery SoC (%)', data: socData, borderColor: '#28a745', backgroundColor: 'rgba(40,167,69,0.1)', tension: 0.3, yAxisID: 'ySoC', fill: true, pointBackgroundColor: socColors },
      { label: 'Battery Voltage (V)', data: voltageData, borderColor: '#007bff', backgroundColor: 'rgba(0,123,255,0.1)', tension: 0.3, yAxisID: 'yVoltage', fill: true },
      { label: 'Battery Damage Risk', data: damageData, borderColor: 'red', backgroundColor: 'red', showLine: false, pointRadius: 4, yAxisID: 'yVoltage' }
    );
  }

  datasets.push({
    label: 'Battery Current (mA)',
    data: days > 15 ? currentDaily : currentData,
    borderColor: 'orange',
    backgroundColor: 'rgba(255,165,0,0.1)',
    tension: 0.3,
    yAxisID: 'yCurrent',
    fill: false
  });

  if (days <= 15) {
    datasets.push(
      { type: 'bar', label: 'Direct Sun', data: sunData, backgroundColor: 'rgba(255,255,0,0.3)', borderWidth: 0, yAxisID: 'yLED' },
      { type: 'bar', label: 'Indirect Sun', data: indirectData, backgroundColor: 'rgba(200,200,0,0.3)', borderWidth: 0, yAxisID: 'yLED' },
      { type: 'bar', label: 'Morning Light', data: morningData, backgroundColor: 'rgba(173,216,230,0.3)', borderWidth: 0, yAxisID: 'yLED' },
      { type: 'bar', label: 'Daylight', data: dayData, backgroundColor: 'rgba(255,165,0,0.3)', borderWidth: 0, yAxisID: 'yLED' },
      { type: 'bar', label: 'LED On', data: ledData, backgroundColor: 'rgba(0,255,255,0.3)', borderWidth: 0, yAxisID: 'yLED' }
    );
  }

  chart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: labelsForChart,
      datasets: datasets
    },
    options: {
      responsive: true,
      scales: {
        x: {
          title: { display: true, text: days > 15 ? 'Day' : 'Time (Hour × Day)' },
          ticks: { maxTicksLimit: 24 * days }
        },
        ySoC: {
          type: 'linear',
          position: 'left',
          min: 0,
          max: 100,
          title: { display: true, text: 'State of Charge (%)' }
        },
        yVoltage: {
          type: 'linear',
          position: 'right',
          min: cells * 1.0,
          max: cells * 1.6,
          title: { display: true, text: 'Battery Voltage (V)' },
          grid: { drawOnChartArea: false }
        },
        yCurrent: {
          type: 'linear',
          position: 'right',
          min: -maxCurrent,
          max: maxCurrent,
          title: { display: true, text: 'Battery Current (mA)' },
          grid: { drawOnChartArea: false },
          offset: true
        },
        yLED: {
          type: 'linear',
          display: false,
          min: 0,
          max: 1
        }
      }
    }
  });
}

window.addEventListener('load', () => {
  simulate();
  document.querySelectorAll('input, select').forEach(el =>
    el.addEventListener('input', simulate));
});
</script>

</body>
</html>
