<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Solar Battery Simulation (Voltage + SoC)</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: sans-serif;
      max-width: 800px;
      margin: 2em auto;
      background: #f8f9fa;
      padding: 2em;
      border-radius: 8px;
    }
    label, input {
      display: block;
      margin-top: 1em;
      width: 100%;
    }
    input {
      padding: 8px;
      font-size: 1em;
    }
    button {
      margin-top: 1em;
      padding: 10px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    canvas {
      margin-top: 30px;
    }
  </style>
</head>
<body>

<h1>Realistic Solar Battery Simulation</h1>

<label for="capacity">Battery Capacity (mAh)</label>
<input type="number" id="capacity" value="1000">

<label for="soc">Initial SoC (%)</label>
<input type="number" id="soc" value="100" min="0" max="100">

<label for="cells">NiCd Cell Count</label>
<input type="number" id="cells" value="1">

<label for="daylightHours">Daylight Duration (hours)</label>
<input type="number" id="daylightHours" value="8">

<label for="ledCurrent">LED Nominal Current @ 1.2V (mA)</label>
<input type="number" id="ledCurrent" value="20">

<label for="days">Days to Simulate</label>
<input type="number" id="days" value="10" min="1">

<h3>Solar Cell</h3>
<label for="voc">Open-Circuit Voltage (Voc) [V]</label>
<input type="number" id="voc" value="1.5" step="any">

<label for="isc">Short-Circuit Current (Isc) [mA]</label>
<input type="number" id="isc" value="150">

<label for="ff">Fill Factor (FF, 0–1)</label>
<input type="number" id="ff" value="0.75" step="any">

<label for="diodeDrop">Diode Voltage Drop (V)</label>
<input type="number" id="diodeDrop" value="0.3" step="any">

<label for="chargeEff">Charge Efficiency (%)</label>
<input type="number" id="chargeEff" value="85" min="0" max="100">

<label for="selfDischarge">Self-Discharge Rate (%/day)</label>
<input type="number" id="selfDischarge" value="1" min="0" step="any">

<button onclick="simulate()">Simulate</button>

<canvas id="chart" width="700" height="400"></canvas>

<script>
let chart;

function simulate() {
  const capacity = parseFloat(document.getElementById("capacity").value);
  const initialSoC = parseFloat(document.getElementById("soc").value);
  const cells = parseInt(document.getElementById("cells").value);
  const daylightHours = parseInt(document.getElementById("daylightHours").value);
  const ledNominalCurrent = parseFloat(document.getElementById("ledCurrent").value);
  const days = parseInt(document.getElementById("days").value);
  const voc = parseFloat(document.getElementById("voc").value);
  const isc = parseFloat(document.getElementById("isc").value);
  const ff = parseFloat(document.getElementById("ff").value);
  const diodeDrop = parseFloat(document.getElementById("diodeDrop").value);
  const chargeEff = parseFloat(document.getElementById("chargeEff").value) / 100;
  const selfDischarge = parseFloat(document.getElementById("selfDischarge").value) / 100;

  let soc = initialSoC;
  const socData = [];
  const voltageData = [];
  const labels = [];

  // LED power at 1.2V baseline
  const ledPower_mW = 1.2 * ledNominalCurrent;

  for (let day = 0; day < days; day++) {
    for (let hour = 0; hour < 24; hour++) {
      labels.push(`Day ${day + 1}, ${hour}:00`);
      socData.push(soc);

      // Battery voltage estimate (1.0V to 1.35V per cell)
      const cellV = 1.0 + 0.35 * (soc / 100);
      const batteryV = cells * cellV;
      voltageData.push(batteryV);

      let delta_mAh = 0;
      const isDay = hour < daylightHours;

      if (isDay) {
        const vLoad = batteryV + diodeDrop;
        if (vLoad < voc) {
          const pMax = voc * isc * ff; // mW
          const vmpp = voc * 0.8; // approximate voltage at MPP
          const impp = pMax / vmpp; // current at MPP
          let solarCurrent;
          if (vLoad <= vmpp) {
            // operate near MPP for lower battery voltage
            solarCurrent = pMax / vLoad;
          } else {
            // linear drop of current above MPP toward Voc
            solarCurrent = impp * (1 - (vLoad - vmpp) / (voc - vmpp));
          }
          solarCurrent = Math.max(0, Math.min(isc, solarCurrent));

          delta_mAh = solarCurrent * chargeEff; // 1 hour
        }
      } else {
        // Adjust LED current to maintain constant power
        const actualLEDCurrent = batteryV > 0 ? ledPower_mW / batteryV : 0;
        delta_mAh = -actualLEDCurrent; // 1 hour
      }

      // self discharge (per hour)
      delta_mAh -= (capacity * selfDischarge) / 24;

      const delta_soc = (delta_mAh / capacity) * 100;
      soc = Math.max(0, Math.min(100, soc + delta_soc));
    }
  }

  const ctx = document.getElementById("chart").getContext("2d");
  if (chart) chart.destroy();

  chart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: labels,
      datasets: [
        {
          label: 'Battery SoC (%)',
          data: socData,
          borderColor: '#28a745',
          backgroundColor: 'rgba(40,167,69,0.1)',
          tension: 0.3,
          yAxisID: 'ySoC',
          fill: true
        },
        {
          label: 'Battery Voltage (V)',
          data: voltageData,
          borderColor: '#007bff',
          backgroundColor: 'rgba(0,123,255,0.1)',
          tension: 0.3,
          yAxisID: 'yVoltage',
          fill: true
        }
      ]
    },
    options: {
      responsive: true,
      scales: {
        x: {
          title: { display: true, text: 'Time (Hour × Day)' },
          ticks: { maxTicksLimit: 24 * days }
        },
        ySoC: {
          type: 'linear',
          position: 'left',
          min: 0,
          max: 100,
          title: { display: true, text: 'State of Charge (%)' }
        },
        yVoltage: {
          type: 'linear',
          position: 'right',
          min: cells * 1.0,
          max: cells * 1.4,
          title: { display: true, text: 'Battery Voltage (V)' },
          grid: { drawOnChartArea: false }
        }
      }
    }
  });
}
</script>

</body>
</html>
